# =============================================================================
# DayZ Server - Docker Compose Configuration (Modernized)
# =============================================================================
# Best practices:
#   - Use compose spec v3.8+ features
#   - Named volumes with labels for better management
#   - Health checks with proper dependencies
#   - Resource limits
#   - Proper service ordering
# =============================================================================

name: dayz-server

volumes:
  homedir:
    name: dayz-homedir
    labels:
      com.dayz.description: "Shared home directory (Steam credentials)"
  serverfiles:
    name: dayz-serverfiles
    labels:
      com.dayz.description: "DayZ server installation"
  profiles:
    name: dayz-profiles
    labels:
      com.dayz.description: "Server profile (config, battleye, VPP)"
  mpmissions-upstream:
    name: dayz-mpmissions-upstream
    labels:
      com.dayz.description: "Upstream pristine mpmissions (read-only source)"
  mpmissions:
    name: dayz-mpmissions
    labels:
      com.dayz.description: "Active mpmissions (server uses these)"
  mods:
    name: dayz-mods
    labels:
      com.dayz.description: "Workshop mods"
  control:
    name: dayz-control
    labels:
      com.dayz.description: "Control plane for API <-> Server communication"

services:
  # ---------------------------------------------------------------------------
  # Init container - one-shot permission fixer
  # ---------------------------------------------------------------------------
  init:
    image: ${REGISTRY:-}dayz-server:${TAG:-latest}-base
    build:
      context: .
      target: base
      args:
        USER_ID: ${USER_ID:-1000}
    user: "0"
    volumes:
      - homedir:/home/user
      - serverfiles:/serverfiles
      - mpmissions-upstream:/mpmissions-upstream
      - mpmissions:/mpmissions
      - mods:/mods
      - profiles:/profiles
      - control:/control
    command: ["python3", "-m", "dayz.cli.init_volumes"]
    restart: "no"
    env_file:
      - path: .env
        required: true
    labels:
      com.dayz.service: "init"
      com.dayz.description: "One-time volume initialization"

  # ---------------------------------------------------------------------------
  # API container - management endpoints
  # ---------------------------------------------------------------------------
  api:
    image: ${REGISTRY:-}dayz-server:${TAG:-latest}-api
    build:
      context: .
      target: api
      args:
        USER_ID: ${USER_ID:-1000}
    # Run as user - use sudo in code for privileged ops
    user: "${USER_ID:-1000}"
    depends_on:
      init:
        condition: service_completed_successfully
    volumes:
      - homedir:/home/user
      - serverfiles:/serverfiles
      - mpmissions-upstream:/mpmissions-upstream
      - mpmissions:/mpmissions
      - mods:/mods
      - profiles:/profiles
      - control:/control
      - type: bind
        source: ./files
        target: /files
        read_only: true
    ports:
      - "${API_PORT:-8080}:8080"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-fsSL", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    env_file:
      - path: .env
        required: true
    environment:
      # Override any env vars here if needed
      - PYTHONUNBUFFERED=1
    labels:
      com.dayz.service: "api"
      com.dayz.description: "Management API server"
    deploy:
      resources:
        limits:
          memory: 2g
          cpus: "2"
        reservations:
          memory: 512m

  # ---------------------------------------------------------------------------
  # Server container - DayZServer process
  # ---------------------------------------------------------------------------
  server:
    image: ${REGISTRY:-}dayz-server:${TAG:-latest}-server
    build:
      context: .
      target: server
      args:
        USER_ID: ${USER_ID:-1000}
    user: "${USER_ID:-1000}"
    depends_on:
      init:
        condition: service_completed_successfully
      api:
        condition: service_healthy
    volumes:
      - homedir:/home/user
      - serverfiles:/serverfiles
      - mpmissions:/mpmissions
      - mods:/mods
      - profiles:/profiles
      - control:/control
      - type: bind
        source: ./files
        target: /files
        read_only: true
    # Host networking for LAN server browser visibility
    # Comment out and use ports below if you don't need LAN discovery
    network_mode: host
    # Uncomment for bridge networking (recommended for production)
    # ports:
    #   - "${GAME_PORT:-2302}:2302/udp"   # Game port
    #   - "${QUERY_PORT:-2303}:2303/udp"  # Steam query
    #   - "${STEAM_PORT:-27016}:27016/udp" # Steam master
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python3", "-m", "dayz.cli.healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    env_file:
      - path: .env
        required: true
    environment:
      - PYTHONUNBUFFERED=1
    labels:
      com.dayz.service: "server"
      com.dayz.description: "DayZ game server"
    deploy:
      resources:
        limits:
          memory: ${SERVER_MEMORY_LIMIT:-8g}
          cpus: ${SERVER_CPU_LIMIT:-4}
        reservations:
          memory: ${SERVER_MEMORY_RESERVE:-4g}
    # Optional: Logging configuration
    # logging:
    #   driver: "json-file"
    #   options:
    #     max-size: "10m"
    #     max-file: "3"

  # ---------------------------------------------------------------------------
  # Web UI - Nginx serving React app and proxying /api to backend
  # ---------------------------------------------------------------------------
  web:
    image: ${REGISTRY:-}dayz-server:${TAG:-latest}-web
    build:
      context: .
      target: web
    depends_on:
      api:
        condition: service_healthy
    ports:
      - "${WEB_PORT:-8081}:80"
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://127.0.0.1/",
        ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    labels:
      com.dayz.service: "web"
      com.dayz.description: "Web UI frontend"
    deploy:
      resources:
        limits:
          memory: 256m
          cpus: "0.5"
        reservations:
          memory: 64m
    # Optional: Read-only root filesystem for better security
    # read_only: true
    # tmpfs:
    #   - /var/cache/nginx
    #   - /var/run
